<!---
Copryight 2017 floragunn GmbH
-->

<h1 id="using-the-example-pki-scripts">Using the example PKI scripts</h1>

<p>If you want to generate the certificates on your own machine, you can use the Search Guard example PKI scripts as a starting point. The scripts are shipped with Search Guard SSL and run on Linux or OS X.</p>

<p>You can use the scripts as-is, or you can edit the configuration files to tailor the certificates to your needs.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>The scripts use OpenSSL and the Java <code class="highlighter-rouge">keytool</code> for generating all required artifacts.</p>

<p>In order to find out if you have OpenSSL installed, open a terminal and type</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl version
</code></pre></div></div>

<p>Make sure it’s version 1.0.1k or higher.</p>

<p>The <code class="highlighter-rouge">keytool</code> ships with the JDK itself and thus should be already available on your machine. Check it by calling</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keytool
</code></pre></div></div>

<p>Which should print a list of available <code class="highlighter-rouge">keytool</code> commands. If this is not the case, check your JDK installation and make sure the <code class="highlighter-rouge">keytool</code> is on your <code class="highlighter-rouge">PATH</code>.</p>

<h2 id="generating-the-certificates">Generating the certificates</h2>

<p>First download the Search Guard SSL source code onto your machine. You can either clone the repository, or download it as zip file. The repository is located here:</p>

<p><a href="https://github.com/floragunncom/search-guard-ssl/tree/es-6.0.0" target="_blank">Search Guard SSL 6.x</a></p>

<p>The script to execute is <code class="highlighter-rouge">./example.sh</code>, located in the folder <code class="highlighter-rouge">example-pki-scripts.</code> You might need to <code class="highlighter-rouge">chmod</code> the file before executing it.</p>

<p>If execution was successful, you’ll find the generated files and folders inside the <code class="highlighter-rouge">example-pki-scripts</code> folder. If for any reason you need to re-execute the script, execute <code class="highlighter-rouge">./clean.sh</code> in the same directory first. This will remove all generated files automatically.</p>

<h2 id="generated-artifacts">Generated artifacts</h2>

<p>The script generates certificates in PEM, P12 and JKS format. You can use either for running Search Guard. The recommended format is PEM.</p>

<p>The following main certicates are generated:</p>

<ul>
  <li>Node certificates:</li>
  <li>node-0-signed.pem / node-0.key.pem</li>
  <li>node-1-signed.pem / node-1.key.pem</li>
  <li>node-2-signed.pem / node-2.key.pem</li>
  <li>Admin certificate:</li>
  <li>kirk.crtfull.pem / kirk.key.pem</li>
  <li>Client certificate:</li>
  <li>spock.crtfull.pem / spock.key.pem</li>
</ul>

<p>In order to configure the kirk certificate as admin certificate, add the following entry to elasticsearch.yml:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>searchguard.authcz.admin_dn:
  - CN=kirk,OU=client,O=client,L=Test,C=DE
</code></pre></div></div>

<p>The script also generates certificates for Kibana, logstash and Beats. These can be used to secure the connection between said tools and Elasticsearch. This is optional but more secure.</p>

<p><strong>The password for all private keys and keystore files is <code class="highlighter-rouge">changeit</code>.</strong></p>

<p>The Root CA and Signing CA used to sign the certificates can be found in the folder <code class="highlighter-rouge">example-pki-scripts/ca</code></p>

<h2 id="customizing-the-certificates">Customizing the certificates</h2>

<p>If you need to customize the certificates generated by the example PKI scripts, the following files are relevant:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>example-pki-scripts/etc/root-ca.conf
example-pki-scripts/etc/signing-ca.conf
</code></pre></div></div>

<p>The example certificates are generated using a certificate chain. It consists of the Root CA, a signing CA and the actual certififcate. The two files stated above define the configuration of the Root CA and signing CA, especially the <code class="highlighter-rouge">Distinguished Name(DN)</code>. You can change the DN in the following section:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span> ca_dn <span class="o">]</span>
0.domainComponent       <span class="o">=</span> <span class="s2">"com"</span>
1.domainComponent       <span class="o">=</span> <span class="s2">"example"</span>
organizationName        <span class="o">=</span> <span class="s2">"Example Com Inc."</span>
organizationalUnitName  <span class="o">=</span> <span class="s2">"Example Com Inc. Root CA"</span>
commonName              <span class="o">=</span> <span class="s2">"Example Com Inc. Root CA"</span>
</code></pre></div></div>

<p>In order to customize the DN of the generated node-, admin-, and client-certificates, modify the following files:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gen_node_cert.sh
  Generates a node certificate

gen_client_node_cert.sh
  Generates a client certificate. 
  Certificates generated by this script can also be used as admin certificate  
</code></pre></div></div>

<p>You can change the DN, the hostname and the IP of the generated certificate by modifying the following sections in the respective files:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-dname "CN=$NODE_NAME.example.com, OU=SSL, O=Test, L=Test, C=DE" \
-ext san=dns:$NODE_NAME.example.com,dns:localhost,ip:127.0.0.1,oid:1.2.3.4.5.5
</code></pre></div></div>

<p><em>Note: For <code class="highlighter-rouge">gen_node_cert.sh</code>, make sure you keep the oid:1.2.3.4.5.5
 part! This OID value is used to identify node certificates in your cluster.</em></p>
