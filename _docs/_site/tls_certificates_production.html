<!---
Copryight 2017 floragunn GmbH
-->
<h1 id="tls-for-production-environments">TLS for production environments</h1>

<p>When moving Search Guard to production you most likely want to use certificates generated by your own PKI infrastructure. This chapter describes the different certificate types and how to generate and configure them.</p>

<h2 id="supported-formats">Supported formats</h2>

<p>Search Guard supports certificates in the following formats:</p>

<ul>
  <li>X509 PEM certificates and PKCS8 private keys</li>
  <li>Keystores and truststores in JKS or PKCS12 format</li>
</ul>

<h2 id="types-of-certificates">Types of certificates</h2>

<p>Search Guard distinguishes between the following types of certificates</p>

<ul>
  <li>Node certificates</li>
  <li>Client certificates</li>
  <li>Admin certificates</li>
</ul>

<p><strong>Node certificates</strong> are used to identify and secure traffic between Elasticsearch nodes on the transport layer (inter-node traffic). For this kind of traffic, no permission checks are applied, i.e. every request is allowed. Therefore, these certificates must meet some special requirements. See below for details and options.</p>

<p><strong>Client certificates</strong> are regular TLS certificates without any special requirements. They are used to identify Elasticsearch clients on the REST and transport layer. They can be used for HTTP client certificate authentication or when using a Java Transport Client on transport layer.</p>

<p><strong>Admin certificates</strong> are <strong>client certificates</strong> that have elevated rights to perform administrative tasks. You need an admin certificate to change the Search Guard configuration via the <a href="sgadmin.md">sgadmin</a> command line tool, or to use the <a href="restapi_api_access.md">REST management API</a>. Admin certificates are configured in <code class="highlighter-rouge">elasticsearch.yml</code> by simply stating their DN(s). You can use any valid client certificate as an admin certificate.</p>

<p><strong><em>Note: Do not use a node certificate as admin certificate! Node and admin certificates should always be kept separate.</em></strong></p>

<h2 id="node-certificates">Node certificates</h2>

<p>Search Guard needs to securely and reliably identify internal communication between Elasticsearch nodes (inter-node traffic). This communication happens for example if one node receives a GET request on the HTTP layer, but needs to forward it to another node that holds the actual data.</p>

<p>Search Guard offers several ways of identifying inter-node traffic. Depending on your PKI setup and capabilities, you can choose from one of the following methods.</p>

<h3 id="listing-dns-of-node-certificates">Listing DNs of node certificates</h3>

<p>The simplest way of configuring node certificates is to list the DNs of these certificates in <code class="highlighter-rouge">elasticsearch.yml</code>. Wildcards and regular expressions are supported:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">searchguard.nodes_dn</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">CN=node.other.com,OU=SSL,O=Test,L=Test,C=DE'</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">CN=*.example.com,OU=SSL,O=Test,L=Test,C=DE'</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">CN=elk-devcluster*'</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">/CN=.*regex/'</span>
</code></pre></div></div>

<p>All certificate DNs listed here are considered valid node certificates.</p>

<h3 id="using-an-oid-value-as-san-entry">Using an OID value as SAN entry</h3>

<p>This is the default setting of Search Guard when no <code class="highlighter-rouge">searchguard.nodes_dn</code> is specified. It is also used as fallback if the certificate’s DN does not match any DN configured in <code class="highlighter-rouge">searchguard.nodes_dn</code>.</p>

<p><code class="highlighter-rouge">OID</code> stands for an object identifier and in this context it is used to identify an X.509 certificate extension, i.e. an additional data field stored in the certificate, which is not predefined by the standard.</p>

<p>If you want to learn more about OIDs in TLS certificates, refer to Red Hats <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Certificate_System/8.0/html/Admin_Guide/Standard_X.509_v3_Certificate_Extensions.html" target="_blank">Standard X.509 v3 Certificate Extension Reference</a>.</p>

<p>The <code class="highlighter-rouge">OID</code> is defined in the <code class="highlighter-rouge">Subject Alternative Name (SAN)</code> section of the certificate, and must have the default value <code class="highlighter-rouge">1.2.3.4.5.5</code> for node certificates. If this value is found, the certificate is considered to be a valid node certificate.</p>

<p>The OID approach is more flexible than listing the DNs individually: All certificates containing this OID value in the SAN field are considered valid node certificates, so you can add new nodes on the fly without changing the <code class="highlighter-rouge">searchguard.nodes_dn</code> setting.</p>

<p>If you want to use this approach, make sure that your CSR includes <code class="highlighter-rouge">oid:1.2.3.4.5.5</code> in the <code class="highlighter-rouge">SAN</code> field.</p>

<h4 id="using-a-custom-oid-value">Using a custom OID value</h4>

<p>If you cannot set the <code class="highlighter-rouge">OID</code> to the default value <code class="highlighter-rouge">1.2.3.4.5.5</code>, but you are able to use a different value, you can configure this value in <code class="highlighter-rouge">elasticsearch.yml</code> by setting:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>searchguard.cert.oid: &lt;String&gt;
</code></pre></div></div>
<h3 id="custom-implementation">Custom implementation</h3>

<p>You can also provide your own implementation to identify inter-node traffic. Please see chapter <a href="tls_expert.md">Expert features</a> for details.</p>

<h2 id="extended-key-usage-settings">Extended key usage settings</h2>

<p>A node certificate is used for server authentication and client authentication:</p>

<ul>
  <li>
    <p>If a node issues an request to another node, it acts like a client, requesting data from a server.</p>
  </li>
  <li>
    <p>If a node receives requests from another node, it acts like a server, accepting requests from the client node.</p>
  </li>
</ul>

<p>Therefore, for node certificates the extended key usage settings must include both <code class="highlighter-rouge">serverAuth</code> and <code class="highlighter-rouge">clientAuth</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#3: ObjectId: 2.5.29.37 Criticality=false</span>
ExtendedKeyUsages <span class="o">[</span>
  serverAuth
  clientAuth
<span class="o">]</span>
</code></pre></div></div>

<h2 id="special-characters-and-whitespaces">Special characters and whitespaces</h2>

<p>Search Guard uses the <a href="https://www.ietf.org/rfc/rfc1779.txt" target="_blank">String Representation of Distinguished Names (RFC1779)</a> when validating node certificates.</p>

<p>If parts of your DN contain special characters, for example a comma, make sure it is escaped properly in your <code class="highlighter-rouge">searchguard.nodes_dn</code> configuration, for example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">searchguard.nodes_dn</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">CN=node.other.com,OU=SSL,O=My\,</span><span class="nv"> </span><span class="s">Test,L=Test,C=DE'</span>
</code></pre></div></div>

<p>Omit whitespaces between the individual parts of the DN. Instead of:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">searchguard.nodes_dn</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">CN=node.other.com,</span><span class="nv"> </span><span class="s">OU=SSL,</span><span class="nv"> </span><span class="s">O=MyTest,</span><span class="nv"> </span><span class="s">L=Test,C=DE'</span>
</code></pre></div></div>

<p>use:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">searchguard.nodes_dn</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">CN=node.other.com,OU=SSL,O=MyTest,L=Test,C=DE'</span>
</code></pre></div></div>

<h2 id="emailaddress-fields">emailAddress Fields</h2>

<p>Using the emailAddress as part of the DN is deprecated. It is recommended to add the email as SAN entry to the certificate instead.</p>

<h2 id="working-with-aliases">Working with aliases</h2>

<p>While it is common to have separate files for storing the trusted root certificates (“truststore”) and the client certificate, technically speaking there is no reason to do so. Means, you can also store the root certificates, intermediate certificates and client certificates in the same file.</p>

<p>In this case you can work with aliases to specify which certificate in your keystore should be used for what purpose.</p>

<p>When importing certificates in your keystore, you can set an alias name like:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keytool <span class="nt">-importcert</span> <span class="nt">-file</span> cert.pem <span class="nt">-keystore</span> keystore.jks <span class="nt">-alias</span> <span class="s2">"myalias"</span>
</code></pre></div></div>

<p>You can later use this alias in the Search Guard TLS configuration to refer to exactly this certificate (or certificate chain), for example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">searchguard.ssl.transport.keystore_filepath keystore.jks</span>
<span class="s">searchguard.ssl.transport.keystore_alias</span><span class="pi">:</span> <span class="s">myalias</span>
</code></pre></div></div>

<h2 id="client-and-admin-certificates">Client and admin certificates</h2>

<p>There are no special requirements for client and admin certificates. So any certificate signed by the Root CA or intermediate CA can be used.</p>

<p>Admin certificates have elevated permissions, including the permission to change the Search Guard index. To assign these elevated permissions to a certificate, simply list them in <code class="highlighter-rouge">elasticsearch.yml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">searchguard.authcz.admin_dn</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">CN=admin,OU=SSL,O=Test,L=Test,C=DE</span>
</code></pre></div></div>

<p><strong>Note: For security reasons, wildcards and regular expressions are not supported for admin certificates!</strong></p>

<h2 id="disable-tls-client-renegotiation">Disable TLS Client Renegotiation</h2>

<p>Secure Client-Initiated Renegotiation is enabled by default, but could be used for denial of service attacks on the HTTP port. If you want to disable Client-Initiated Renegotiation for production, add the following line to config/jvm.options:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-Djdk.tls.rejectClientInitiatedRenegotiation=true
</code></pre></div></div>

<h2 id="disable-tls-versions-and-weak-ciphers">Disable TLS versions and weak ciphers</h2>

<p>You can control the enabled ciphers and TLS protocols by the following configuration keys in <code class="highlighter-rouge">elasticsearch.yml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">searchguard.ssl.http.enabled_ciphers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">TLS_DHE_RSA_WITH_AES_256_CBC_SHA"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">TLS_DHE_DSS_WITH_AES_128_CBC_SHA256"</span>
<span class="s">searchguard.ssl.http.enabled_protocols</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">TLSv1.1"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">TLSv1.2"</span>
</code></pre></div></div>

<p>See the <a href="tls_configuration.md">TLS configuration chapter</a> for more details.</p>
