<!---
Copryight 2017 floragunn GmbH
-->

<h1 id="using-sgadmin-to-configure-search-guard">Using sgadmin to configure Search Guard</h1>

<p>The Search Guard configuration, including users, roles and permissions, is stored in an index on the Elasticsearch cluster. This allows for hot configuration reloading, and eliminates the need to place configuration files on any node.</p>

<p>Configuration settings are loaded into the Search Guard configuration index using the <code class="highlighter-rouge">sgadmin</code> tool. <code class="highlighter-rouge">sgadmin</code> identifies itself against a Search Guard secured Elasticsearch cluster via an admin TLS certificate, either in <code class="highlighter-rouge">.pem</code> or <code class="highlighter-rouge">.jks</code> format.</p>

<p>If the Search Guard index is inititialized, you can also use the Kibana Configuration GUI to change users, roles and permissions. However, you need to run <code class="highlighter-rouge">sgadmin</code> at least once to initialize the index and configure the authentication and authorization methods you would like to use.</p>

<h2 id="configuring-the-admin-certificate">Configuring the admin certificate</h2>

<p>You can configure all certificates that should have admin privileges in <code class="highlighter-rouge">elasticsearch.yml</code> by stating their respective DNs. If you use the <a href="https://github.com/floragunncom/search-guard-ssl/tree/master/example-pki-scripts" target="_blank">example PKI scripts</a> to generate the certificates, you can use the <em>kirk</em> or <em>spock</em> client certificate:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">searchguard.authcz.admin_dn</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">CN=kirk,OU=client,O=client,L=test,C=DE</span>
  <span class="pi">-</span> <span class="s">CN=spock,OU=client,O=client,L=test,C=DE</span>
</code></pre></div></div>

<p><em>Do not use node certificates as admin certifcates. The intended use is to keep node and admin certificates separate. Using node certificates as admin certificates can lead to unexpected results. Also, do not use any whitespaces between the parts of the DN.</em></p>

<h2 id="basic-usage">Basic Usage</h2>

<p>The sgadmin CLI tool can be run from any machine that has access to the transport port of your Elasticsearch cluster (default: 9300). This means that you can change the Search Guard configuration without having to access your nodes via SSH.</p>

<p>Search Guard ships with sgadmin included:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;ES installation directory&gt;/plugins/search-guard-/tools
</code></pre></div></div>

<h3 id="linux">Linux</h3>

<p>Change the permissions on that script and give it execution rights:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod +x plugins/search-guard-/tools/sgadmin.sh
</code></pre></div></div>

<h3 id="windows">Windows</h3>

<p>Before executing sgadmin.bat check that you have set JAVA_HOME environment variable, e.g.:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set JAVA_HOME=C:\Program Files\Java\jdk1.8.0_65
</code></pre></div></div>

<p>Replace <code class="highlighter-rouge">jdk1.8.0_65</code> with your installed JDK or JRE version.</p>

<h3 id="standalone-version">Standalone version</h3>

<p>You can also download the sgadmin standalone version. It comes with all dependencies included, so you can use it on any machine you want, provided Java is installed.</p>

<p>You can find all versions on <a href="https://search.maven.org/#search%7Cgav%7C1%7Cg%3A%22com.floragunn%22%20AND%20a%3A%22search-guard-6%22" target="_blank">Maven Central</a>.</p>

<p>Choose the Search Guard version you are running and download and unpack either:</p>

<ul>
  <li>sgadmin-standalone.tar.gz or</li>
  <li>sgadmin-standalone.zip</li>
</ul>

<h3 id="print-all-command-line-options">Print all command line options</h3>

<p>To print all available command line options, execute sgadmin without any command line switches:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;ES installation directory&gt;/plugins/search-guard-/tools/sgadmin.sh
</code></pre></div></div>

<h2 id="using-sgadmin-with-pem-certificates">Using sgadmin with PEM certificates</h2>

<p>In order to use sgadmin for pushing configuration changes to Search Guard, you need to provide your admin certificate to the tool.</p>

<p>If you use the certificates generated by the <a href="quickstart.md">demo installation script</a>, cd in the <code class="highlighter-rouge">&lt;ES installation directory&gt;/plugins/search-guard-/tools/</code> and execute:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./sgadmin.sh <span class="nt">-cd</span> ../sgconfig/ <span class="nt">-icl</span> <span class="nt">-nhnv</span>  
   <span class="nt">-cacert</span> ../../../config/root-ca.pem 
   <span class="nt">-cert</span> ../../../config/kirk.pem 
   <span class="nt">-key</span> ../../../config/kirk-key.pem 
</code></pre></div></div>

<p>The <code class="highlighter-rouge">-cd</code> option speficies where the Search Guard configuration files to upload to the cluster can be found.</p>

<p>The <code class="highlighter-rouge">-icl</code> (<code class="highlighter-rouge">--ignore-clustername</code>) option tells Search Guard to upload the config regardless of the cluster name. As an alternative you can also specify the clustername with the <code class="highlighter-rouge">-cn</code> (<code class="highlighter-rouge">--clustername</code>) option. Since we use self-signed certificates, we also disable hostname verification with the <code class="highlighter-rouge">-nhnv</code> (<code class="highlighter-rouge">--disable-host-name-verification</code>) option.</p>

<p>The <code class="highlighter-rouge">-cacert</code>, <code class="highlighter-rouge">-cert</code> and <code class="highlighter-rouge">-key</code> switches define the location of your Root CA certificate, the admin certificate and the private key for the admin certificate. If the private key has a password, specify it with the <code class="highlighter-rouge">-keypass</code> switch.</p>

<p>All PEM options:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-cert</td>
      <td>The location of the pem file containing the admin certificate and all intermediate certificates, if any. You can use an absolute or relative path. Relative paths are resolved relative to the execution directory of sgadmin.</td>
    </tr>
    <tr>
      <td>-key</td>
      <td>The location of the pem file containing the private key of the admin certificate. You can use an absolute or relative path. Relative paths are resolved relative to the execution directory of sgadmin. The key must be in PKCS#8 format.</td>
    </tr>
    <tr>
      <td>-keypass</td>
      <td>The password of the private key of the admin certificate, if any.</td>
    </tr>
    <tr>
      <td>-cacert</td>
      <td>The location of the pem file containing the root certificate. You can use an absolute or relative path. Relative paths are resolved relative to the execution directory of sgadmin.</td>
    </tr>
  </tbody>
</table>

<h2 id="using-sgadmin-with-keystore-and-truststore-files">Using sgadmin with Keystore and Truststore files</h2>

<p>You can also use keystore files in JKS format in conjunction with <code class="highlighter-rouge">sgadmin</code>, for example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./sgadmin.sh <span class="nt">-cd</span> ../sgconfig <span class="nt">-icl</span> <span class="nt">-nhnv</span> 
  <span class="nt">-ts</span> &lt;path/to/truststore&gt; <span class="nt">-tspass</span> &lt;truststore password&gt; 
  <span class="nt">-ks</span> &lt;path/to/keystore&gt; <span class="nt">-kspass</span> &lt;keystore password&gt; 
  
</code></pre></div></div>

<p>Use the following options to control the key and truststore settings:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-ks</td>
      <td>The location of the keystore containing the admin certificate and all intermediate certificates, if any. You can use an absolute or relative path. Relative paths are resolved relative to the execution directory of sgadmin.</td>
    </tr>
    <tr>
      <td>-kspass</td>
      <td>The password for the keystore.</td>
    </tr>
    <tr>
      <td>-kst</td>
      <td>The key store type, either JKS or PKCS12. If not specified, Search Guard tries to deduct the type from the file extension.</td>
    </tr>
    <tr>
      <td>-ksalias</td>
      <td>The alias of the admin certificate, if any.</td>
    </tr>
    <tr>
      <td>-ts</td>
      <td>The location of the truststore containing the root certificate. You can use an absolute or relative path. Relative paths are resolved relative to the execution directory of sgadmin.</td>
    </tr>
    <tr>
      <td>-tspass</td>
      <td>The password for the truststore.</td>
    </tr>
    <tr>
      <td>-tst</td>
      <td>The trust store type, either JKS or PKCS12. If not specified, Search Guard tries to deduct the type from the file extension.</td>
    </tr>
    <tr>
      <td>-tsalias</td>
      <td>The alias for the root certificate, if any.</td>
    </tr>
  </tbody>
</table>

<h2 id="command-line-options">Command line options</h2>

<p>sgadmin comes with command line options. Execute <code class="highlighter-rouge">./sgadmin.sh</code> without any options to list them.</p>

<h3 id="general">General</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-ff</td>
      <td>fail fast if something goes wrong, no retry</td>
    </tr>
  </tbody>
</table>

<h3 id="elasticsearch-settings">Elasticsearch settings</h3>

<p>If you run a default Elasticsearch installation, which listens on transport port 9300, and uses <code class="highlighter-rouge">elasticsearch</code> as cluster name, you can omit the following settings altogether. Otherwise, specify your Elasticsearch settings by using the following switches:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-h</td>
      <td>elasticsearch hostname, default: localhost</td>
    </tr>
    <tr>
      <td>-p</td>
      <td>elasticsearch port, default: 9300 (NOT the http port!)</td>
    </tr>
    <tr>
      <td>-cn</td>
      <td>clustername, default: elasticsearch</td>
    </tr>
    <tr>
      <td>-icl</td>
      <td>Ignore clustername.</td>
    </tr>
    <tr>
      <td>-sniff</td>
      <td>Sniff cluster nodes.</td>
    </tr>
    <tr>
      <td>-arc,–accept-red-cluster</td>
      <td>Execute sgadmin even if the cluster state is red. Default: sgadmin won’t execute on red cluster state</td>
    </tr>
  </tbody>
</table>

<p>Ignore cluster name means that the name of your cluster will not be validated. Sniffing can be used to detected available nodes by using the ES cluster state API. You can read more about this feature in the <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/transport-client.html">Elasticsearch documentation</a>.</p>

<h3 id="certificate-validation-settings">Certificate validation settings</h3>

<p>Use the following options to control certificate validation:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-nhnv</td>
      <td>disable-host-name-verification, do not validate hostname. Default: false</td>
    </tr>
    <tr>
      <td>-nrhn</td>
      <td>disable-resolve-hostname, do not resolve hostname (Only relevant if -nhnv is not set.).</td>
    </tr>
    <tr>
      <td>-noopenssl</td>
      <td>Do not use OpenSSL even if available (default: use OpenSSL if available)</td>
    </tr>
  </tbody>
</table>

<h3 id="configuration-files-settings">Configuration files settings</h3>

<p>The following switches define which configuration file(s) you want to push to Search Guard. You can either push a single file or specify a directory containing one or more configuration files.</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-cd</td>
      <td>Directory containing multiple Search Guard configuration files.</td>
    </tr>
    <tr>
      <td>-f</td>
      <td>Single config file (cannot be used together with -cd).</td>
    </tr>
    <tr>
      <td>-t</td>
      <td>File type.</td>
    </tr>
    <tr>
      <td>-rl</td>
      <td>Reload the current configuration and flush the internal cache.</td>
    </tr>
  </tbody>
</table>

<p>To upload all configuration files in a directory, use:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./sgadmin.sh <span class="nt">-cd</span> ../sgconfig <span class="nt">-ts</span> ... <span class="nt">-tspass</span> ... <span class="nt">-ks</span> ... <span class="nt">-kspass</span> ...
</code></pre></div></div>

<p>If you want to push a single configuration file, use:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./sgadmin.sh <span class="nt">-f</span> ../sg_internal_users.yml <span class="nt">-t</span> internalusers  <span class="se">\</span>
    <span class="nt">-ts</span> ... <span class="nt">-tspass</span> ... <span class="nt">-ks</span> ... <span class="nt">-kspass</span> ...
</code></pre></div></div>

<p>the filetype must be one of:</p>

<ul>
  <li>config</li>
  <li>roles</li>
  <li>rolesmapping</li>
  <li>internalusers</li>
  <li>actiongroups</li>
</ul>

<h3 id="cipher-settings">Cipher settings</h3>

<p>Usually you do not need to change the cipher settings. If you do, use the following switches:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-ec</td>
      <td>enabled-ciphers, comma separated list of enabled TLS ciphers.</td>
    </tr>
    <tr>
      <td>-ep</td>
      <td>enabled-protocols, comma separated list of enabled TLS protocols.</td>
    </tr>
  </tbody>
</table>

<h3 id="backup-and-restore">Backup and Restore</h3>

<p>You can download all current configuration files from your cluster with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./sgadmin.sh <span class="nt">-r</span> <span class="nt">-ts</span> ... <span class="nt">-tspass</span> ... <span class="nt">-ks</span> ... <span class="nt">-kspass</span> ...
</code></pre></div></div>

<p>This will dump the currently active Search Guard configuration from your cluster to individual files in the working directory. You can then use these files to upload the configuration again to the same or a different cluster. This is for example useful when moving a PoC to production.</p>

<p>You can also specify the download location with the -cd option:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./sgadmin.sh <span class="nt">-r</span> <span class="nt">-h</span> staging.example.com <span class="nt">-p</span> 9300  <span class="se">\</span>
    <span class="nt">-cd</span> /etc/backup/ <span class="nt">-ts</span> ... <span class="nt">-tspass</span> ... <span class="nt">-ks</span> ... <span class="nt">-kspass</span> ...
</code></pre></div></div>

<p>To upload the dumped files to another cluster use:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./sgadmin.sh <span class="nt">-h</span> production.example.com <span class="nt">-p</span> 9301 <span class="nt">-cd</span> /etc/backup/  <span class="se">\</span>
    <span class="nt">-ts</span> ... <span class="nt">-tspass</span> ... <span class="nt">-ks</span> ... <span class="nt">-kspass</span> ...
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-r</td>
      <td>retrieve the current Search Guard configuration from a running cluster, and dump it to configuration files in the working directory</td>
    </tr>
    <tr>
      <td>-cd</td>
      <td>Specify the directory to store the files to. You can use an absolute or relative path. Relative paths are resolved relative to the execution directory of sgadmin.</td>
    </tr>
  </tbody>
</table>

<h3 id="rescue-tools">Rescue tools</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-dci</td>
      <td>Delete the Search Guard configuration index and exit. May be useful if the cluster state is red due to a corrupt Search Guard index.</td>
    </tr>
    <tr>
      <td>-esa</td>
      <td>Enable shard allocation and exit. May be useful if you disabled shard allocation while performing a full cluster restart, and you need to recreate the Search Guard index.</td>
    </tr>
  </tbody>
</table>

<h3 id="license-information">License information</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-si</td>
      <td>Displays the currently active Search Guard license</td>
    </tr>
  </tbody>
</table>

<h3 id="whoami">Whoami</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-w</td>
      <td>Displays information about the used admin certificate</td>
    </tr>
  </tbody>
</table>

<h3 id="cache-invalidation">Cache invalidation</h3>

<p>Search Guard by default caches authenticated users and their roles and permissions for one hour. You can invalidate the cache by reloading the Search Guard configuration:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./sgadmin.sh <span class="nt">-rl</span> <span class="nt">-ts</span> ... <span class="nt">-tspass</span> ... <span class="nt">-ks</span> ... <span class="nt">-kspass</span> ...
</code></pre></div></div>
<p>| Name | Description |
|—|—|
| -rl | reload the current Search Guard configuration stored in your cluster, invalidating any cached users, roles and permissions.|</p>

<h3 id="index-and-replica-settings">Index and replica settings</h3>

<p>The following switched control the Search Guard index settings.</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-i</td>
      <td>Search Guard index name, defaults to searchguard.</td>
    </tr>
    <tr>
      <td>-us</td>
      <td>Update the replica settings.</td>
    </tr>
    <tr>
      <td>-era</td>
      <td>Enable replica auto-expand.</td>
    </tr>
    <tr>
      <td>-dra</td>
      <td>Disable replica auto-expand.</td>
    </tr>
  </tbody>
</table>

<p>The first time you run sgadmin.sh, the <code class="highlighter-rouge">-us</code>, <code class="highlighter-rouge">-era</code>, <code class="highlighter-rouge">dra</code>, and <code class="highlighter-rouge">-rl</code> (reload configuration), flags can cause the initial setup to fail, as the searchguard index does not yet exist.</p>

<p>See chapter <a href="sgindex.md">index management</a> for more details on how the Search Guard index is structured and how to manage it.</p>

